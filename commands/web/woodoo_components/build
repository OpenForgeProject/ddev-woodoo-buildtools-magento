#!/bin/bash
#ddev-generated - Do not modify this file; your modifications will be overwritten.

# Build all themes in config-themes.yaml
if [[ $1 == "build" && $2 == "" || $1 == "b" && $2 == "" || $1 == "build" && $2 == "-f" || $1 == "b" && $2 == "-f" ]]; then

    # Check all themes in config-themes.yaml to create a list of available themes
    checkThemePathExists silent

    # trunk-ignore(shellcheck/SC2312)
    if [[ $(countThemesinConfig) -lt 1 ]]; then
        echo -e "${txtred}No Theme is available to build${txtrst}\n"
        echo -e "${txtgrn}Please add a Theme to ${txtcyn}${PROJECT_CONFIG_FILE}${txtrst}${txtrst}\n"
        addThemesToConfig
        # trunk-ignore(shellcheck/SC2312)
    elif [[ $(countThemesinConfig) == 1 ]]; then
        # trunk-ignore(shellcheck/SC2312)
        echo -e "${txtgrn}$(countThemesinConfig) Theme is ready to build:${txtrst}\n"
    else
        # trunk-ignore(shellcheck/SC2312)
        echo -e "${txtgrn}$(countThemesinConfig) Themes are ready to build:${txtrst}\n"
    fi

    # if more then one theme is available, ask if all themes should be build
    # trunk-ignore(shellcheck/SC2312)
    if [[ $(countThemesinConfig) -gt 1 && $2 != '-f' ]]; then
        THEMES_TO_BUILD=$(gum choose --cursor-prefix "[ ] " --unselected-prefix "[ ] " --selected-prefix "[✓] " --no-limit $THEMES_IN_CONFIG)
    else
        THEMES_TO_BUILD=${THEMES_IN_CONFIG}
    fi

    for THEME_CODE in ${THEMES_TO_BUILD}; do
        THEME_TO_BUILD=$(echo $(grep -oP '(?<='$THEME_CODE': ).*' $PROJECT_CONFIG_FILE) | cut -d ' ' -f 1 | sed 's/"//g')

        # checks to figure out if it is a Hyvä Theme
        checkHyva "${THEME_TO_BUILD}"

        # try to build as Hyvä Theme
        if [[ ${HYVA} == true ]]; then
            buildHyva "$THEME_TO_BUILD" "$THEME_CODE"
        else
            buildMagentoDefault "$THEME_CODE"
        fi

    done

    clearCache
    clearStaticFiles

fi

# Build a specific Theme
if [[ $1 == "build" && $2 != "" && $2 != "-f" || $1 == "b" && $2 != "" && $2 != "-f" ]]; then

    # Check get all themes from config-themes.yaml
    checkThemePathExists

    # check if 2nd parameter ($2) is a valid theme code
    if [[ ! " ${THEMES_IN_CONFIG[@]} " =~ " ${2} " ]]; then
        echo -e "\n${txtred}${ICON_ERROR} ${2} is not a valid theme-code. Please check your $PROJECT_CONFIG_FILE${txtrst}"
        echo -e "${txtcyn}\nAvailable Themes in $PROJECT_CONFIG_FILE:${txtrst}"
        getThemesInConfig
        echo -e "\n"
        exit 0
    else
        THEME_TO_BUILD=$(echo $(grep -oP '(?<='$2': ).*' $PROJECT_CONFIG_FILE) | cut -d ' ' -f 1 | sed 's/"//g')

        checkHyva $THEME_TO_BUILD

        if [[ $HYVA == true ]]; then
            buildHyva "$THEME_TO_BUILD" "$2"
        else
            buildMagentoDefault "$2"
        fi

        clearCache
        clearStaticFiles

    fi
fi
