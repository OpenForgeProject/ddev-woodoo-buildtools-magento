#!/bin/bash
#ddev-generated - Do not modify this file; your modifications will be overwritten.

# This function runs the Magento command to generate the Hyvä theme configuration.
function hyvaConfigGenerate() {
    echo -e "\n${txtcyn}${ICON_ARROW_RIGHT} Generate Hyvä Configuration ... ${txtrst}"
    "${DDEV_COMPOSER_ROOT}"/bin/magento hyva:config:generate
}

# This function runs the Magento command to flush the cache.
function clearCache() {
    "${DDEV_COMPOSER_ROOT}"/bin/magento cache:flush
    echo -e "\n${txtgrn}Cache cleared${txtrst}"
}

# This function removes the static files and view preprocessed files generated by Magento.
function clearStaticFiles() {
    rm -rf "${DDEV_COMPOSER_ROOT}"/pub/static/* "${DDEV_COMPOSER_ROOT}"/var/view_preprocessed/*
    echo -e "${txtgrn}Magento Static files cleared${txtrst}"
}

# Runs the necessary Grunt tasks from project root to build the theme
# DDEV_COMPOSER_ROOT is the path to the project root directory
function runGruntTasks() {
    "${DDEV_COMPOSER_ROOT}"/node_modules/.bin/grunt clean
    "${DDEV_COMPOSER_ROOT}"/node_modules/.bin/grunt less
}

# Builds the Hyvä theme specified by the first argument and the theme code by the second argument
# HYVA_PATH is the path to the Hyvä theme directory
# TEMP_THEME_NAME is the theme name (code) of the theme

function getInstalledHyvaVersion() {
    HYVA_VERSION=""
    local TEMP_THEME_NAME=$2

    # Check if a composer.json exists in the theme directory
    # If not, use the composer.json from the Magento root directory to get the Hyvä version
    if [[ ! -f "${DDEV_COMPOSER_ROOT}/$1/composer.json" ]]; then
        echo -e "${txtylw}${ICON_WARNING} Could not find composer.json in Theme ($1)"
        echo -e "${txtcyn}${ICON_ARROW_RIGHT} Use composer.json from Magento-Root instead${txtrst}"
        cd "${DDEV_COMPOSER_ROOT}" || exit
        HYVA_VERSION=$(grep -oP '(?<="hyva-themes/magento2-default-theme": ").*' composer.json | cut -d ' ' -f 1 | sed 's/"//g')
    else
        cd "${DDEV_COMPOSER_ROOT}/$1" || exit
        HYVA_VERSION=$(grep -oP '(?<="hyva-themes/magento2-default-theme": ").*' composer.json | cut -d ' ' -f 1 | sed 's/"//g')
    fi

    HYVA_VERSION=$(echo "${HYVA_VERSION}" | sed 's/,//g')
    echo -e "${txtgrn}${ICON_ARROW_RIGHT} ${txtpur}${TEMP_THEME_NAME}${txtcyn} is a Hyvä ${txtpur}${HYVA_VERSION}${txtcyn} Theme${txtrst}\n"
    cd - >/dev/null || exit
}

# check if node_modules needs to be updated
function checkNpmOutdatedPackages() {
    if [[ -d "$1/web/tailwind/node_modules" ]]; then
        cd "$1/web/tailwind" || exit
        echo -e "${txtcyn}${ICON_ARROW_RIGHT} Check for outdated dependencies ... ${txtrst}\n"
        npm outdated --silent || npm ci
        echo -e "${txtcyn}${ICON_SUCCESS} Dependencies check done.${txtrst}"
        cd - >/dev/null || exit
    fi
}

# check if all dependencies are up to date in node_modules folder
function checkNodeModules() {
    if [[ ! -d "$1/web/tailwind/node_modules" ]]; then
        echo -e "\n${txtylw}${ICON_WARNING} Install missing npm dependencies (node_modules) ... ${txtrst}"
        cd "$1/web/tailwind" || exit
        npm ci
        if [[ -d "./node_modules" ]]; then
            echo -e "\n${txtcyn}${ICON_SUCCESS} npm dependencies installed.${txtrst}"
            cd - >/dev/null || exit
        else
            echo -e "${txtred}${ICON_ERROR} Could not install npm dependencies. Please check $1/web/tailwind/node_modules ${txtrst}"
            cd - >/dev/null || exit
        fi
    else
        echo -e "${txtcyn}${ICON_SUCCESS} node_modules folder found.${txtrst}"
    fi
}

function installGrunt() {
    npm install
    sudo npm install grunt -g
    sudo npm install grunt-cli -g
}

# Function to check if Hyva theme is present in the specified build path
# Parameters:
#   $1: The build path

function checkHyva() {
    HYVA=false
    local BUILD_PATH=$1
    local HYVA_FOLDER=${BUILD_PATH}/web/tailwind
    if [[ -d ${HYVA_FOLDER} && -f "${HYVA_FOLDER}/tailwind.config.js" && -f "${HYVA_FOLDER}/package.json" ]]; then
        HYVA=true
    fi
}

# Function to read themes from config-themes.yaml and store them in THEMES_IN_CONFIG variable
# Parameters:
#   None

function readThemesInConfig() {
    THEMES_IN_CONFIG=""
    if [[ ! -f ${PROJECT_CONFIG_FILE} ]]; then
        echo -e "\n${txtred}No ${PROJECT_CONFIG_FILE} found.' first.${txtrst}\n"
        exit 1
    fi
    while read -r line; do
        # Check whether the line with "Themes:" begins
        if [[ ${line} =~ ^themes: ]]; then
            while read -r next_line; do
                # Check whether the next line begins with "-"
                if [[ -n ${next_line} && ${next_line} =~ ^- ]]; then
                    THEMES_IN_CONFIG="${THEMES_IN_CONFIG} $(echo "${next_line}" | cut -d ' ' -f 2 | cut -d ':' -f 1)"
                else
                    break
                fi
            done
        fi
    done <"${PROJECT_CONFIG_FILE}"
}

# Function to check if theme paths exist in the configuration file
#
# Parameters:
#   $1 (optional) - If set to "silent", suppresses the output messages
#
# Description:
#   This function reads the themes from the config-themes.yaml file and checks if the theme paths are configured correctly.
#   It iterates through each theme code and checks if the corresponding theme path is configured and if the registration.php file exists in the theme path.
#   If any theme path is not configured correctly, it sets the PATH_ERROR flag to true and exits the script.
#   If all theme paths are valid, it prints a success message.
#
# Example usage:
#   checkThemePathExists
#   checkThemePathExists silent
#

function checkThemePathExists() {

    # get all themes from config-themes.yaml
    readThemesInConfig

    local PATH_ERROR=false

    if [[ -z ${THEMES_IN_CONFIG} ]]; then
        echo -e "\n${txtred}No Themes found in ${PROJECT_CONFIG_FILE}}${txtrst}\n"
    else
        if [[ $1 != "silent" ]]; then
            # Check if only 1 theme is configured
            if [[ $(countThemesinConfig) == 1 ]]; then
                echo -e "\n${txtgrn}$(countThemesinConfig) Theme added to ${txtcyn}${PROJECT_CONFIG_FILE}${txtrst}\n"
            else
                echo -e "\n${txtgrn}$(countThemesinConfig) Themes added to ${txtcyn}${PROJECT_CONFIG_FILE}${txtrst}\n"
            fi
        fi
        for THEME_CODE in ${THEMES_IN_CONFIG}; do
            while read -r line; do
                # Check whether the line with "Themes:" begins
                if [[ ${line} =~ ^themes: ]]; then
                    while read -r next_line; do
                        THEME_PATHES_VALID=null
                        # Check whether the next line begins with "-"
                        if [[ -n ${next_line} && ${next_line} =~ ^- ]]; then
                            if [[ ${next_line} =~ ${THEME_CODE} ]]; then
                                THEME_PATH=$(echo "${next_line}" | cut -d ' ' -f 3 | cut -d '"' -f 2)

                                if [[ ${THEME_PATH} == "" ]]; then
                                    if [[ $1 != "silent" ]]; then
                                        echo -e "${txtred}${ICON_ERROR} Theme-Path ${txtpur}${THEME_CODE} ${txtred}has not been configured yet.${txtrst}"
                                    fi
                                    THEME_PATHES_VALID=false
                                    PATH_ERROR=true
                                else
                                    # if $THEME_PATHES_VALID not false and registration.php exists in $THEME_PATH
                                    if [[ ${THEME_PATHES_VALID} != false && -f ${THEME_PATH}/registration.php ]]; then
                                        THEME_PATHES_VALID=true
                                        if [[ $1 != "silent" ]]; then
                                            echo -e "${txtgrn}${ICON_SUCCESS} ${txtcyn}Theme ${txtpur}${THEME_CODE} ${txtcyn}is correct.${txtrst}"
                                        fi
                                    else
                                        THEME_PATHES_VALID=false
                                        PATH_ERROR=true
                                        echo -e "${txtred}${ICON_ERROR} Theme-Path ${txtpur}${THEME_CODE} ${txtred}has not been configured correctly.${txtrst}"
                                    fi
                                fi
                            fi
                        fi
                    done
                    break
                fi
            done <"${PROJECT_CONFIG_FILE}"
        done

        # if checkThemePathExists has an error, it will exit the script
        if ${PATH_ERROR}; then
            echo -e "\n${txtylw}${ICON_WARNING} Some theme paths are invalid! Please check your ${PROJECT_CONFIG_FILE} ${txtrst}\n"
            exit 0
        else
            echo -e "\n${txtgrn}${ICON_SUCCESS} All theme paths are valid!${txtrst}\n"
        fi
    fi
}
